<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>确认预约</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin-bottom: 20px; }
        #Image1 { display: inline-block; width: 100px; height: 40px; background: #eee; border: 1px solid #ccc; vertical-align: middle; }
        .time-options { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; }
        .time-option { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; border: 1px solid #eee; border-radius: 4px; }
        .time-option input { margin-bottom: 6px; }
        .time-option label { display: block; }
        .disabled { color: red; cursor: not-allowed; }
        .enabled { color: blue; cursor: pointer; }
        button { padding: 8px 16px; }
        .abc { color: red; font-size: 14px; margin-top: 5px; }
    </style>
</head>
<body>
    <h2>请完成预约确认</h2>

    <!-- 第一部分：验证码 -->
    <div class="section">
        <label>图形验证：</label>
        <input type="text" id="txtTxYz" placeholder="请输入验证码">
        <canvas id="Image1" width="100" height="40"></canvas>
        <a href="javascript:void(0)" id="LinkButton1">点此刷新验证码</a>
        <div id="div1" class="abc"></div>
    </div>

    <!-- 第二部分：时间选择 -->
    <div class="section" id="Panel1">
        <h3>选择预约时间</h3>
        <div style="margin-bottom:8px">剩余可选时间：<span id="remainingCount">0</span></div>
        <div class="time-options" id="timeOptionsContainer">
            <!-- 将由脚本动态生成 4 行 x 8 列 的时间选项 -->
        </div>
    </div>

    <!-- 第三部分：提交按钮 -->
    <div class="section">
        <button id="btnConfirm">提交</button>
    </div>

    <script>
        // 存储当前验证码文本，用于校验
        let currentCaptcha = '';
        let captchaGeneratedTime = 0; // 记录验证码生成时间

        // 生成随机验证码文本
        function generateCaptcha() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // 在 Canvas 上绘制验证码
        function drawCaptcha(text) {
            const canvas = document.getElementById('Image1');
            const ctx = canvas.getContext('2d');

            // 清空画布
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 设置字体
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#000';

            // 绘制字符（逐个添加偏移，模拟扭曲效果）
            for (let i = 0; i < text.length; i++) {
                const x = 10 + i * 20 + Math.random() * 5 - 2.5; // 水平偏移
                const y = 30 + Math.random() * 5 - 2.5;          // 垂直偏移
                ctx.fillText(text[i], x, y);
            }

            // 添加干扰线
            for (let i = 0; i < 5; i++) {
                ctx.strokeStyle = `hsl(${Math.random()*360}, 50%, 50%)`;
                ctx.beginPath();
                ctx.moveTo(Math.random()*100, Math.random()*40);
                ctx.lineTo(Math.random()*100, Math.random()*40);
                ctx.stroke();
            }

            // 添加噪点
            for (let i = 0; i < 30; i++) {
                ctx.fillStyle = `hsl(${Math.random()*360}, 50%, 50%)`;
                ctx.fillRect(Math.random()*100, Math.random()*40, 2, 2);
            }
        }

        // 保存初始验证码
        const initialCaptcha = generateCaptcha();
        currentCaptcha = initialCaptcha;
        captchaGeneratedTime = Date.now();
        drawCaptcha(currentCaptcha);

        // 刷新验证码（不清除错误提示）
        document.getElementById('LinkButton1').addEventListener('click', function() {
            currentCaptcha = generateCaptcha();
            captchaGeneratedTime = Date.now(); // 更新生成时间
            drawCaptcha(currentCaptcha);
        });

        // 提交按钮逻辑
        document.getElementById('btnConfirm').addEventListener('click', function() {
            const captcha = document.getElementById('txtTxYz').value.trim().toLowerCase();
            const correctCaptcha = currentCaptcha.toLowerCase();
            
            // 检查验证码是否过期（超过1分钟，即60000毫秒）
            const currentTime = Date.now();
            const isExpired = (currentTime - captchaGeneratedTime) > 60000;

            if (captcha !== correctCaptcha) {
                // 根据是否过期显示不同的错误提示
                if (isExpired) {
                    document.getElementById('div1').innerHTML = '图形验证码不正确或者已过期.';
                } else {
                    document.getElementById('div1').innerHTML = '请输入正确的验证码.';
                }
                
                // 恢复到初始验证码
                currentCaptcha = initialCaptcha;
                captchaGeneratedTime = Date.now(); // 重置时间
                drawCaptcha(currentCaptcha);
                return;
            }

            // 验证码正确，清除错误提示
            document.getElementById('div1').innerHTML = '';

            // 检查是否选中了可用时间
            const selected = document.querySelector('input[name="time"]:checked');
            if (!selected) {
                alert('请先选择一个时间');
                return;
            }

            // 检查是否选中了禁用项
            if (selected.classList.contains('disabled')) {
                alert('当前选择的时间不可用');
                return;
            }

            // 在跳转前把所选时间立即设为不可用，模拟抢占成功后的锁定
            selected.disabled = true;
            selected.classList.remove('enabled');
            selected.classList.add('disabled');
            const lab = document.querySelector(`label[for="${selected.id}"]`);
            if (lab) {
                lab.classList.remove('enabled');
                lab.classList.add('disabled');
            }

            // 更新剩余计数
            const remEl = document.getElementById('remainingCount');
            if (remEl) {
                remEl.textContent = Array.from(document.getElementsByName('time')).filter(i => !i.disabled).length;
            }

            // 成功跳转
            window.location.href = 'success.html';
        });

        // 动态生成 4 行 x 8 列 时间选项（共 32 个），并在生成后启动 2 分钟内逐步将可选项随机设为不可选
        (function generateTimeOptionsAndStartReduction() {
            const container = document.getElementById('timeOptionsContainer');
            const total = 32;
            const startHour = 13, startMinute = 30;

            function pad(n) {
                return n.toString().padStart(2, '0');
            }

            // 初始全部标为可用（也可根据需要预设部分禁用）
            for (let i = 0; i < total; i++) {
                const minutes = startHour * 60 + startMinute + i * 7;
                const hh = Math.floor(minutes / 60) % 24;
                const mm = minutes % 60;
                const timeLabel = `${pad(hh)}:${pad(mm)}`;

                const div = document.createElement('div');
                div.className = 'time-option';

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'time';
                input.id = `RadioButton${i}`;
                input.className = 'enabled';

                const label = document.createElement('label');
                label.htmlFor = input.id;
                label.textContent = timeLabel;
                label.className = 'enabled';

                div.appendChild(input);
                div.appendChild(label);
                container.appendChild(div);
            }

            // 剩余计数更新函数
            function updateRemaining() {
                const rem = Array.from(document.getElementsByName('time')).filter(i => !i.disabled).length;
                const el = document.getElementById('remainingCount');
                if (el) el.textContent = rem;
                return rem;
            }

            // 在 totalDuration 内把所有可选项随机逐步禁用
            function startReduction(totalDurationMs) {
                const enabledElems = () => Array.from(document.getElementsByName('time')).filter(i => !i.disabled);
                let remaining = updateRemaining();
                if (remaining === 0) return;

                // 计划禁用次数等于当前可用数量
                const toDisable = remaining;
                // 每次禁用的间隔
                const interval = Math.max(50, Math.floor(totalDurationMs / toDisable));

                const timer = setInterval(() => {
                    const candidates = enabledElems();
                    if (candidates.length === 0) {
                        clearInterval(timer);
                        return;
                    }

                    // 随机选择一个并禁用
                    const chosen = candidates[Math.floor(Math.random() * candidates.length)];
                    chosen.disabled = true;
                    chosen.classList.remove('enabled');
                    chosen.classList.add('disabled');

                    const lab = document.querySelector(`label[for="${chosen.id}"]`);
                    if (lab) {
                        lab.classList.remove('enabled');
                        lab.classList.add('disabled');
                    }

                    updateRemaining();

                    // 如果已经禁完，停止
                    if (Array.from(document.getElementsByName('time')).filter(i => !i.disabled).length === 0) {
                        clearInterval(timer);
                    }
                }, interval);
            }

            // 启动 2 分钟（120000 ms）内逐步禁用所有可选项
            startReduction(10000);
        })();
    </script>
</body>
</html>
